Lab-4-
Работа с микроконтроллером ESP8266 и прошивкой MicroPython

Для начала установите Python, убедившись, что он корректно добавлен в PATH системы,а затем

```
python -m pip install --upgrade pip
python -m pip install esptool
```

что позволит вам установить утилиту esptool. Далее подключите вашу плату ESP к компьютеру через USB‑кабель и откройте «Диспетчер устройств». В разделе «Порты (COM & LPT)» найдите устройство с названием типа USB‑Serial (например, CP210x или USB‑SERIAL CH340) и запомните его номер COM‑порта, например COM3. После этого в PowerShell выполните

Открой PowerShell и выполни (замени COM3 на свой порт):

```
python -m esptool --port COM3 flash_id`
```

Теперь перейдите на официальный сайт и скачайте прошивку, соответствующую объёму вашей флеш‑памяти. Затем очистите флеш командой
```
python -m esptool --port COM3 erase_flash
```

Перейди сюда (официальный сайт): https://micropython.org/download/ 
и скачать прошивку соответствующей объему 
Загрузите прошивку с помощью
```
python -m esptool --port COM3 --baud 460800 write_flash --flash_size=detect 0 ваша прошивка 
```


Необходимо установить программу для работы с MicroPython можно скачать с офф сайта  https://thonny.org/ или попросить преподавателя дистрибутив
Tеперь настройте среду разработки: откройте инструмент для работы с MicroPython, перейдите в меню «Инструменты → Параметры → Интерпретатор» и выберите вариант «MicroPython (ESP8266)», указав свой COM‑порт.
![[Pasted image 20251121010723.png]]

После этого создайте файл `boot.py`, сохраните его на устройстве ESP и поместите туда код подключения к Wi‑Fi:
Файл → Новый → Сохранить как → **boot.py** → выбрать **MicroPython device**
```
import network
import time

ssid = "ИмяWiFi"
password = "ПарольWiFi"

wlan = network.WLAN(network.STA_IF)
wlan.active(True)

if not wlan.isconnected():
    print("Connecting to WiFi...")
    wlan.connect(ssid, password)
    while not wlan.isconnected():
        time.sleep(1)

print("Connected to WiFi")
print("ESP IP:", wlan.ifconfig()[0])

```
Запомните IP‑адрес, который будет выведен. Затем создайте файл `main.py` на устройстве с кодом веб‑сервера:
Файл → Новый → Сохранить как → **main.py** → устройство ESP
 ```
 from micropyserver import MicroPyServer

server = MicroPyServer()

def handler_root(request):
    server.send("HELLO WORLD!")

server.add_route("/", handler_root)

server.start()


  ```
Для корректной работы потребуется разместить на устройстве файлы micropyserver.py и utils.py, которые можно взять из репозитория на GitHub (например, [https://github.com/troublegum/micropyserver] Далее реализуйте управление реле через HTTP‑запросы следующим образом:
```import socket
import machine

# Встроенный светодиод на ESP8266
led = machine.Pin(2, machine.Pin.OUT)
led.value(1)  # включен низким уровнем, выключен высоким

# Настройка сокета
addr = socket.getaddrinfo('0.0.0.0', 80)[0][-1]
s = socket.socket()
s.bind(addr)
s.listen(5)
s.settimeout(0.5)
print("Listening on", addr)

while True:
    try:
        cl, addr = s.accept()
    except OSError:
        continue

    request = cl.recv(1024).decode()

    if '/on' in request:
        led.value(0)  # включаем светодиод
        html = "<h1>LED ON</h1><a href='/off'>Turn OFF</a>"
    elif '/off' in request:
        led.value(1)  # выключаем светодиод
        html = "<h1>LED OFF</h1><a href='/on'>Turn ON</a>"
    else:
        html = "<h1>HELLO WORLD!</h1><a href='/on'>ON</a> <a href='/off'>OFF</a>"

    response = 'HTTP/1.0 200 OK\r\nContent-type: text/html\r\n\r\n' + html
    cl.send(response)
    cl.close()

```
Наконец, организуйте вывод данных с датчика DHT11
```import socket
import machine
import dht
import time

sensor = dht.DHT11(machine.Pin(14))
led = machine.Pin(2, machine.Pin.OUT)
led.value(1)

# Создание сокета
addr = socket.getaddrinfo('0.0.0.0', 80)[0][-1]
s = socket.socket()
s.bind(addr)
s.listen(5)
s.settimeout(0.5)
print("Listening on", addr)

while True:
    try:
        cl, addr = s.accept()
    except OSError:
        continue

    request = cl.recv(1024).decode()

    # Считываем DHT11
    try:
        sensor.measure()
        temp = sensor.temperature()
        hum = sensor.humidity()
        sensor_data = f"Temp: {temp}°C, Hum: {hum}%"
    except OSError:
        sensor_data = "Sensor error"

    # Управление LED
    if '/on' in request:
        led.value(0)
    elif '/off' in request:
        led.value(1)

    html = f"<h1>HELLO WORLD</h1><p>{sensor_data}</p><a href='/on'>LED ON</a> <a href='/off'>LED OFF</a>"
    response = 'HTTP/1.0 200 OK\r\nContent-type: text/html\r\n\r\n' + html
    cl.send(response)
    cl.close()

```
**Варианты заданий:**
**Вариант 1. “Умная вентиляция помещения”**  
Студент реализует систему, где HTTP-запрос `/vent/open` открывает окно с помощью сервопривода, а `/vent/close` закрывает. DHT11 измеряет температуру и влажность, и если температура превышает 26 °C, окно открывается автоматически. HC-SR04 контролирует препятствия перед створкой, светодиод отображает состояние вентиляции (зелёный — открыто, красный — закрыто), а кнопка позволяет закрыть окно вручную.

**Вариант 2. “Бесконтактный дозатор антисептика”**  
HC-SR04 измеряет расстояние до руки, и если оно меньше 10 см, HTTP-запрос `/dispense` активирует сервопривод, имитируя подачу дозы. DHT11 контролирует температуру, и при превышении 30 °C загорается красный светодиод. Кнопка позволяет подать дозу вручную, а светодиод отображает состояние устройства: зелёный — готов, красный — перегрев.

**Вариант 3. “Умная кормушка”**  
HC-SR04 фиксирует подход животного, а HTTP-запрос `/feed` открывает крышку с помощью сервопривода. DHT11 следит за температурой и при перегреве подача корма блокируется. Светодиод сигнализирует о работе кормушки, а кнопка позволяет вручную открыть крышку.

**Вариант 4. “Система безопасности входной зоны”**  
HC-SR04 определяет движение на расстоянии до 50 см, и HTTP-запрос `/alarm_on` включает тревогу, включая светодиод и реле, а `/alarm_off` отключает сигнализацию. DHT11 измеряет температуру и влажность. Сервопривод закрывает заслонку при срабатывании, а кнопка отключает тревогу вручную.

**Вариант 5. “Автоматическая проветривательная система теплицы”**  
DHT11 измеряет температуру и влажность, и при превышении порога HTTP-запрос `/vent/open` открывает створку сервоприводом, а `/vent/close` закрывает. HC-SR04 контролирует отсутствие препятствий перед створкой, светодиод отображает активность системы, а кнопка обеспечивает ручное управление.

**Вариант 6. “Умная мусорная урна”**  
HC-SR04 фиксирует приближение руки, и HTTP-запрос `/lid/open` открывает крышку с помощью сервопривода, а `/lid/close` закрывает её. DHT11 контролирует температуру корпуса, светодиод отображает состояние крышки, а кнопка закрывает крышку вручную.

**Вариант 7. “Система полива мини-модели”**  
HTTP-запрос `/water_on` включает полив с помощью сервопривода, `/water_off` выключает. DHT11 контролирует влажность воздуха, и если она ниже 40 %, полив включается автоматически. HC-SR04 проверяет отсутствие объектов поблизости, светодиод показывает режим работы, а кнопка активирует или отключает автоматический режим.

**Вариант 8. “Интерактивный температурный индикатор”**  
HTTP-запрос `/measure` запускает измерение. HC-SR04 измеряет расстояние до пользователя, DHT11 температуру, сервопривод устанавливает стрелку-индикатор на угол от 0 до 180 °. Светодиод мигает быстрее при высокой температуре, а кнопка активирует измерение вручную.

**Вариант 9. “Умный кондиционер”**  
HTTP-запрос `/cool_on` включает кондиционер, открывая заслонку сервоприводом, `/cool_off` выключает систему. DHT11 контролирует температуру, HC-SR04 фиксирует наличие человека. Светодиод показывает состояние работы, а кнопка запускает ручной режим охлаждения.

**Вариант 10. “Веб-управляемое окно безопасности”**  
HTTP-запрос `/window/open` открывает окно с помощью сервопривода, `/window/close` закрывает его. DHT11 контролирует температуру, HC-SR04 проверяет наличие препятствий, и если объект появляется ближе 10 см, окно закрывается автоматически. Светодиод отображает состояние окна, а кнопка позволяет открыть его вручную.

**Вариант 11. “Система контроля уровня жидкости”**  
HC-SR04 измеряет уровень жидкости, HTTP-запрос `/valve/open` открывает клапан, `/valve/close` закрывает. DHT11 контролирует температуру. Светодиод сигнализирует о переполнении, а кнопка сбрасывает тревогу.

**Вариант 12. “Веб-система охраны”**  
HC-SR04 фиксирует движение, HTTP-запрос `/alarm_on` включает тревогу с реле и светодиодом, `/alarm_off` отключает её. DHT11 измеряет температуру и влажность. Сервопривод закрывает заслонку при срабатывании, а кнопка отключает тревогу вручную.

**Вариант 13. “Интеллектуальное освещение с вентиляцией”**  
HTTP-запрос `/light_on` включает светодиод, `/vent_open` открывает вентиляционную заслонку сервоприводом. HC-SR04 фиксирует движение, DHT11 контролирует температуру. Светодиод и сервопривод реагируют на условия, а кнопка переключает режимы освещения.

**Вариант 14. “Мини-система климатического мониторинга”**  
HTTP-запрос `/status` возвращает данные DHT11 и HC-SR04. Сервопривод устанавливает угол (0°, 90°, 180°) в зависимости от показаний, реле управляет внешним устройством, светодиод показывает статус измерения, а кнопка запускает измерение вручную.
